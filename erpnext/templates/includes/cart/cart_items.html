{% from "erpnext/templates/includes/macros.html" import product_image %}

{% macro item_subtotal(item) %}
<div>
	{% if item.is_free_item and item.item_booking %}
	{% set item_booking = frappe.get_doc("Item Booking", item.item_booking) %}
	{% set credits = item_booking.get_deducted_credits() %}
	{% set credit_unit = _("Credits") if credits > 1 else _("Credit") %}
	<span class="credit-chip">
		<svg fill="var(--primary)" height="18px" width="18px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 296.477 296.477" xml:space="preserve">
			<g>
				<path d="M244.63,35.621c-21.771-18.635-47.382-29.855-73.767-33.902C121.871-5.797,70.223,11.421,35.622,51.847   c-53.236,62.198-45.972,155.773,16.226,209.01c21.771,18.634,47.381,29.853,73.766,33.901   c48.991,7.517,100.641-9.703,135.241-50.13C314.091,182.431,306.826,88.856,244.63,35.621z M273.361,191.241l-45.305-15.618   c6.102-17.803,6.028-37.107,0.014-54.724l45.257-15.575c3.577,10.453,5.862,21.429,6.74,32.741   C281.489,156.374,279.152,174.388,273.361,191.241z M275.905,104.058c0-0.003,0-0.005,0-0.008   C275.905,104.053,275.905,104.055,275.905,104.058z M247.935,61.472l-36.069,31.332c-2.669-3.055-5.579-5.961-8.752-8.677   c-11.467-9.814-24.81-15.995-38.637-18.692l9.095-46.741c22.33,4.33,43.21,14.294,60.635,29.209   C239.147,52.131,243.728,56.669,247.935,61.472z M103.251,23.983c6.428-2.315,13.021-4.109,19.71-5.388l9.087,46.843   c-17.789,3.467-34.584,12.651-47.393,27.341L48.55,61.38C63.334,44.416,82.206,31.568,103.251,23.983z M23.124,105.236   l45.297,15.617c-6.102,17.803-6.028,37.105-0.015,54.723l-45.295,15.588c-3.562-10.441-5.837-21.4-6.713-32.688   C14.976,140.151,17.32,122.11,23.124,105.236z M48.467,235.066l36.145-31.395c2.669,3.056,5.58,5.964,8.754,8.68   c11.466,9.814,24.808,15.993,38.634,18.691l-9.143,46.997c-22.325-4.348-43.185-14.422-60.604-29.333   C57.288,244.458,52.689,239.898,48.467,235.066z M193.203,272.635c-6.409,2.309-12.986,4.11-19.658,5.403l-9.117-47   c17.789-3.467,34.585-12.651,47.394-27.342l36.121,31.409C233.154,252.087,214.257,265.047,193.203,272.635z"/>
				<circle cx="93.372" cy="53.498" r="8"/>
				<circle cx="38.758" cy="148.382" r="8"/>
				<circle cx="93.623" cy="243.123" r="8"/>
				<circle cx="203.105" cy="242.977" r="8.001"/>
				<circle cx="257.717" cy="148.091" r="8"/>
				<circle cx="202.853" cy="53.351" r="8"/>
			</g>
		</svg>
	</span>
	<span>{{ credits }} {{ credit_unit }}</span>
	{% else %}
	{{ item.get_formatted('amount') }}
	{% endif %}
</div>

{% if item.is_free_item and not item.item_booking %}
<div class="text-success mt-4">
	<span class="free-tag">
		{{ _('Free') }}
	</span>
</div>
{% elif not item.is_free_item %}
<span class="item-rate">
	{{ _('Rate:') }} {{ item.get_formatted('rate') }}
</span>
{% endif %}
{% endmacro %}

{% for d in doc.items %}
{% set dataAttributes = {
"data-item-code": d.item_code,
"data-item-booking": d.item_booking
} | xmlattr %}
<tr data-name="{{ d.name }}">
	<td style="width: 60%;">
		<div class="d-flex">
			<div class="cart-item-image mr-4">
				{% if d.thumbnail %}
				{{ product_image(d.thumbnail, alt="d.web_item_name", no_border=True) }}
				{% else %}
				<div class="no-image-cart-item">
					{{ frappe.utils.get_abbr(d.web_item_name) or "NA" }}
				</div>
				{% endif %}
			</div>

			<div class="d-flex w-100" style="flex-direction: column;">
				<div class="item-title mb-1 mr-3">
					{{ d.get("web_item_name") or d.item_name }}
				</div>
				<div class="item-subtitle mr-2">
					<a href="{{ d.route }}">{{ d.item_code }}</a>
				</div>

				{% if d.item_booking %}
				{% set item_booking_doc = frappe.db.get_value('Item Booking', d.item_booking, ['starts_on', 'ends_on'], as_dict=True) %}
				<span class="item-subtitle mt-2">
					{{ _("Date") }}: {{ frappe.utils.format_date(item_booking_doc.starts_on) }}
				</span>
				<span class="item-subtitle">
					{{ _("Time", null, "Cart") }}: {{ frappe.utils.format_time(item_booking_doc.starts_on) }} - {{ frappe.utils.format_time(item_booking_doc.ends_on) }}
				</span>
				{% endif %}

				{%- set variant_of = frappe.db.get_value('Item', d.item_code, 'variant_of') %}
				{% if variant_of %}
				<span class="item-subtitle mr-2">
					{{ _('Variant of') }}
					<a href="{{frappe.db.get_value('Website Item', {'item_code': variant_of}, 'route') or '#'}}">
						{{ variant_of }}
					</a>
				</span>
				{% endif %}

				<div class="mt-2 notes">
					<textarea {{ dataAttributes }} class="form-control" rows="2" placeholder="{{ _('Add notes') }}">
							{%- if d.additional_notes %}{{ d.additional_notes }}{% endif -%}
						</textarea>
				</div>
			</div>
		</div>
	</td>

	<!-- Qty column -->
	<td class="text-right" style="width: 25%;">
		<div class="d-flex">
			{% if d.item_booking %}
			<div class="modify-booking-btn column-sm-view d-flex" {{ dataAttributes }}>
				<a href="{{ d.route }}?date={{ frappe.utils.getdate(item_booking_doc.starts_on) }}">{{ _("Modify") }}</a>
			</div>
			{% else %}
			{% set disabled = 'disabled' if d.is_free_item else '' %}
			<div class="input-group number-spinner mt-1 mb-4">
				<span class="input-group-prepend d-sm-inline-block">
					<button class="btn cart-btn" data-dir="dwn" {{ disabled }}>
						{{ 'â€“' if not d.is_free_item else ''}}
					</button>
				</span>

				<input class="form-control text-center cart-qty" value="{{ d.get_formatted('qty') }}" {{ dataAttributes }}" style="max-width: 70px;" {{ disabled }}>

				<span class="input-group-append d-sm-inline-block">
					<button class="btn cart-btn" data-dir="up" {{ disabled }}>
						{{ '+' if not d.is_free_item else ''}}
					</button>
				</span>
			</div>
			{% endif %}

			<div>
				{% if not d.is_free_item %}
				<div class="remove-cart-item column-sm-view d-flex" {{ dataAttributes }}>
					<span>
						<svg class="icon sm remove-cart-item-logo" width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg" id="icon-close">
							<path fill-rule="evenodd" clip-rule="evenodd" d="M4.146 11.217a.5.5 0 1 0 .708.708l3.182-3.182 3.181 3.182a.5.5 0 1 0 .708-.708l-3.182-3.18 3.182-3.182a.5.5 0 1 0-.708-.708l-3.18 3.181-3.183-3.182a.5.5 0 0 0-.708.708l3.182 3.182-3.182 3.181z" stroke-width="0"></path>
						</svg>
					</span>
				</div>
				{% endif %}
			</div>
		</div>


		<!-- Shown on mobile view, else hidden -->
		{% if cart_settings.enable_checkout or cart_settings.show_price_in_quotation %}
		<div class="text-right sm-item-subtotal">
			{{ item_subtotal(d) }}
		</div>
		{% endif %}
	</td>

	<!-- Subtotal column -->
	{% if cart_settings.enable_checkout or cart_settings.show_price_in_quotation %}
	<td class="text-right item-subtotal column-sm-view w-100">
		{{ item_subtotal(d) }}
	</td>
	{% endif %}
</tr>
{% endfor %}
