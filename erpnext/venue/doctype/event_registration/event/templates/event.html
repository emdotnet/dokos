<!-- sitemap -->
{% extends "templates/web.html" %}

{% block header %}
<h1 itemprop="headline">{{ title }}</h1>
{% endblock %}

{% block header_actions %}
	{% if show_close_button%}
		{% if can_edit_event %}
			<a class="btn btn-secondary" href="/app/event/{{ doc.name }}">
				<svg class="icon icon-xs"><use href="#icon-edit"></use></svg>
				{{ _("Edit") }}
			</a>
		{% endif %}

		<button class="btn btn-secondary close-btn">{{ _("Close") }}</button>

		{% if allow_cancellations and is_registered %}
			<button class="btn btn-danger cancel-btn">{{ _("Cancel your registration") }}</button>
		{% endif %}
	{% endif %}
{% endblock %}

{% block page_content %}
	<div class="mb-5">
		{% if doc.image %}
		<img class="card-img-top" src="{{ doc.image }}" alt="{{ doc.subject }}">
		{% endif %}

		{% set event_is_fully_booked = allow_registrations and event_capacity_info.has_limit and not event_capacity_info.free %}
		{% set event_show_capacity = allow_registrations and event_capacity_info.has_limit and not is_registered %}
		{% if allow_registrations %}
			{% set event_state = "full" if event_is_fully_booked else "free" %}
		{% else %}
			{% set event_state = "closed" %}
		{% endif %}

		<div class="card-body event-info" data-event-state="{{ event_state }}" data-is-registered="{{ 'yes' if is_registered else 'no' }}">
			{% if not portal_print_format %}
				<h5 class="card-title">{{ subject or "" }}</h5>
			{% endif %}

			{% if event_show_capacity %}
				{% if event_is_fully_booked %}
					<div class="alert alert-danger mt-5 text-center" role="alert">
						{{ _("This event is fully booked.") }}
					</div>
				{% else %}
					<div class="alert alert-info mt-5 text-center is-unregistered" role="alert">
						{% if event_capacity_info.free == 1 %}
							{{ _("Only one place remaining.") }}
						{% else %}
							{{ _("{0} places remaining").format(event_capacity_info.free) }}
						{% endif %}
					</div>
				{% endif %}
			{% endif %}

			{% if is_registered %}
				<div class="is-registered">
					<div class="alert alert-success mt-5 text-center" role="alert">
						{{ _("You are registered for this event") }}
					</div>
				</div>
			{% endif %}

			{{ content }}

			{% if attachments %}
			<ul class="list-group mb-4">
				{% for attachment in attachments %}
				<li class="list-group-item">
					<span><i class="uil uil-file"></i></span>
					<a href="{{ attachment.file_url }}" target="_blank">
						<span class="ml-1">{{ attachment.file_name }}</span>
					</a>
				</li>
				{% endfor %}
			</ul>
			{% endif %}

			<div class="event-alert-zone"></div>

			{% if allow_registrations %}
				<div id="registration-button" class="text-right">
					{% if not event_is_fully_booked %}
						{% if registration_url %}
						<div><a class="btn btn-primary register-btn" href="{{ registration_url }}">{{ _("Registration Form") }}</a></div>
						{% else %}
						<div><button class="btn btn-primary register-btn">{{ _("Registration Form") }}</button></div>
						{% endif %}
					{% endif %}
				</div>

			{% if not registration_url %}
			<div id="registration-form" style="display: none;">
				<hr class="my-5" />
				<div class="registration-fields"></div>
				<div class="text-right">
					<div><button class="btn btn-primary registration-submit-btn data-registration">{{ _("Register") }}</button></div>
				</div>
			</div>
			{% endif %}
			{% endif %}
		</div>
	</div>
{% endblock %}

{% block style %}
	<style>{{ event_style }}</style>
	<style>
		.frappe-control:not([data-fieldtype='MultiSelectPills']):not([data-fieldtype="Table MultiSelect"]).has-error input {
			border: 1px solid #F9966C;
		}

		.frappe-control:not([data-fieldtype='MultiSelectPills']):not([data-fieldtype="Table MultiSelect"]).has-error input:focus {
			box-shadow: 0 0 0 0.2px #F9966C;
		}

		.frappe-control[data-fieldtype='MultiSelectPills'].has-error .control-input-wrapper {
			box-shadow: 0 0 0 0.2px #F9966C;
		}

		.page-break {
			border-bottom: none;
		}

		.alert {
			box-shadow: 0 0 0 0.5px currentColor;
		}

		.event-info[data-is-registered="no"] .is-registered,
		.event-info[data-is-registered="yes"] .is-unregistered,
		.event-info[data-is-registered="no"] .cancel-btn,
		.event-info[data-is-registered="yes"] .register-btn,
		.event-info[data-is-registered="yes"] .registration-submit-btn,
		.event-info[data-is-registered="yes"] #registration-form {
			display: none !important;
		}
	</style>
{% endblock%}


{% block base_scripts %}
{{ super() }}
{{ include_script("controls.bundle.js") }}
{{ include_script("dialog.bundle.js") }}
{% endblock %}

{% block script %}
<script>
	const THIS_EVENT = {{ doc.name | tojson }};
	const CUSTOM_SUCCESS_MESSAGE = {{ _(doc.success_message or "") | tojson }};

	const set_ui_registration_state = ({ isRegistered }) => {
		$(".event-info[data-is-registered]").attr("data-is-registered", isRegistered ? "yes" : "no");
		$(".registration-submit-btn").attr("disabled", isRegistered);

		if (!isRegistered) {
			$(".event-alert-zone").empty();
		}
	}

	const registration_cancelled = () => {
		$("#registration-form").hide();
		set_ui_registration_state({ isRegistered: false });
		$(".cancel-btn").attr("disabled", false);
		frappe.unfreeze();

		location.reload();
	}

	const bind_cancel_btn = () => {
		$(".cancel-btn").on("click", (e) => {
			e.preventDefault();
			$(".cancel-btn").attr("disabled", true);
			frappe.call({
				method: "erpnext.venue.doctype.event_registration.event_registration.cancel_registration",
				args: {
					event: THIS_EVENT
				},
				freeze: true,
			}).then(r => {
				registration_cancelled();
			})
		});
	}

	const bind_close_btn = () => {
		$(".close-btn").on("click", (e) => {
			e.preventDefault();
			window.location.href = "/events";
		});
	}

	frappe.ready(function() {
		bind_close_btn()
		bind_cancel_btn()
	});

	{% if not registration_url %}
	// Inline registration form
	const REGISTRATION_FORM_FIELDS = {{ registration_form }};

	const register_now = (values) => {
		if (!values) { return; }

		frappe.freeze();
		$(".registration-submit-btn").attr("disabled", true);

		frappe.call({
			method: "erpnext.venue.doctype.event_registration.event_registration.register_to_event",
			args: {
				event: THIS_EVENT,
				data: values
			}
		}).then(r => {
			if (r && r.message) {
				registration_succeeded(r.message)
			} else {
				registration_failed(r)
			}
		}).catch((r) => registration_failed(r))
	}

	const registration_succeeded = (registration_doc) => {
		if (CUSTOM_SUCCESS_MESSAGE) {
			if (CUSTOM_SUCCESS_MESSAGE.includes("<")) {
				$(".event-alert-zone").html(CUSTOM_SUCCESS_MESSAGE);
			} else {
				$(".event-alert-zone").html(`<div class="alert alert-success mt-5 text-center" role="alert">
					<span>${CUSTOM_SUCCESS_MESSAGE}</span>
				</div>`);
			}
		} else {
			const msg = {{ _("Thank you! You have been successfully registered.") | json }}
			$(".event-alert-zone").html(`<div class="alert alert-success mt-5 text-center" role="alert">
				<span>${msg}</span>
			</div>`);
		}

		set_ui_registration_state({ isRegistered: true });
		frappe.unfreeze();
	}

	const registration_failed = (r) => {
		set_ui_registration_state({ isRegistered: false });
		frappe.unfreeze();

		if (r && r.exc_type === "EventIsFull") {
			$(".registration-submit-btn").attr("disabled", false);
			frappe.msgprint(__("This event is fully booked."), __("Registration failed"));
		} else {
			console.error(r);
			$(".registration-submit-btn").attr("disabled", false);
			frappe.msgprint(__("An error prevented your registration. Please try again or contact us."), __("Registration failed"));
		}
	}

	const bind_register_btn = () => {
		$(".register-btn").on("click", (e) => {
			e.preventDefault();
			show_registration_form();
		})
	}

	const show_registration_form = () => {
		$("#registration-form").show();

		const body = $(".registration-fields").get(0);
		body.innerHTML = "" // clear
		const form = new frappe.ui.FieldGroup({
			fields: REGISTRATION_FORM_FIELDS,
			body: body,
			no_submit_on_enter: true
		});
		form.make();

		if (frappe.session.user != "Guest") {
			frappe.call({
				method: "erpnext.venue.doctype.event_registration.event_registration.get_user_info",
			}).then(r => {
				if (r && r.message) {
					form.set_values(r.message);
				}
			})
		}

		$(".registration-submit-btn").off("click").on("click", (e) => {
			e.preventDefault();
			register_now(form.get_values());
		})
	}

	frappe.ready(function() {
		bind_register_btn()
	});
	{% endif %}
</script>
{% endblock %}
